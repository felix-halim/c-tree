<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<script src="d3.v3.min.js"></script>
<script src="linechart2.js?1"></script>
<script>
var opts_arr = [], opts_selected = 0;

d3.csv('results.csv')

.row(function (d) {
  d.Q = +d.Q;
  d.insert_time = +d.insert_time;
  d.query_time = +d.query_time + 1e-9;
  d.update_time = +d.update_time + 1e-9;
  d.total_time = d.insert_time + d.query_time + d.update_time;
  d.avg_time = d.total_time / d.Q;
  d.qps = d.Q / d.total_time;
  return d;
})

.get(function (error, rows) {
  data = rows;
  var fields = ['algorithm', 'query_workload', 'update_workload', 'selectivity'];
  var s = '<tr>';
  for (var i = 0; i < fields.length; i++) {
    var name = fields[i];
    s += '<th align="left" width="160">' + name + '</th>';
  }
  s += '</tr>';

  var distinct_values = {};
  for (var i = 0; i < data.length; i++) {
    for (var j = 0; j < fields.length; j++) {
      var v = data[i][fields[j]];
      if (!distinct_values[fields[j]]) distinct_values[fields[j]] = {};
      distinct_values[fields[j]][v] = 1;
    }
  }

  s += '<tr>';
  for (var i = 0; i < fields.length; i++) {
    var values = distinct_values[fields[i]];
    s += '<td valign="top"><ul style="margin-left:0; margin-top:0; padding-left:20px; padding-top:0">';
    for (var v in values) if (values.hasOwnProperty(v)) {
      s += '<li>' + v + '</li>';
    }
    s += '</ul></td>';
  }
  s += '</tr>';

  document.getElementById('dimensions').innerHTML = s;
  document.getElementById('config').addEventListener('input', render, false);

  var graphs = document.getElementsByClassName('graph');
  var s = '';
  Array.prototype.forEach.call(graphs, function (src, ith) {
    eval('var opts = ' + src.innerText);
    opts_arr.push(src.innerText);
    s += '<option value="' + ith + '">' + opts.title + '</option>';
  });
  document.getElementById('graph-selections').innerHTML = s;
  opts_changed();
});

function render() {
  var ta = document.getElementById('config');
  eval('var opts = ' + ta.value);
  var svg = document.getElementById('chart');
  while (svg.firstChild) svg.removeChild(svg.firstChild);
  linechart(svg, opts);
}

function opts_changed() {
  var i = document.getElementById('graph-selections').selectedIndex;
  document.getElementById('config').value = opts_arr[i];
  render();
}

function dl() {
  var svg = document.getElementById('chart');
  $('#p').val(svg.innerHTML);
  $('#svg2pdf').submit();
}
</script>
</head>


<body>


<div style="float:left; margin:auto">
  <form id="svg2pdf" method="post" action="http://uhunt2.felix-halim.net:8000/svg2pdf">
    <input type="text" id="p" name="p" value="" hidden>
    <button style="float:right; margin-right:30px" onclick="dl()">Save as PDF</button>
    Graph: <select id="graph-selections" onchange="opts_changed()"></select>
  </form>
  <div id="chart" style="width:500px; height:300px;"></div>
</div>

<table id="dimensions" style="display:none" border="0"></table>

<textarea id="config" rows="30" cols="150" style="font-size:12px; clear:both"></textarea>

<script type="text/plain" class="graph">
{
  title: 'Vary #Touch',
  description: 'On random workload, without updates, it is preferable to not transit to ART. Stays in the cracked large bucket state.',
  width: 350, height: 300,
  xAxis: {
    label: 'Query Sequence',
    attr: 'Q',
    scale: 'log',
    domain: [0.5, 2e9],
    format: 'pow10',
    ticks: [1, 10, 1e2, 1e3, 1e4, 1e5, 1e6, 1e7, 1e8, 1e9],
    margin: 40,
  },
  yAxis: {
    label: 'Ratio to ART',
    attr: 'total_time',
    scale: 'log',
    domain: [0.04, 3],
    format: '',
    ticks: [0.05, 0.06, 0.07, 0.08, 0.09, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1, 2, 3],
    margin: 40
  },
  base: 'art_best_eager',
  lines: {
    fields : ['algorithm', 'query_workload', 'update_workload', 'N'],
    values : [
      { label: [      'ART',   20,  50], color: 'green', line: '', value:['art_best_eager', 'Random', 'NOUP', 100000000] },
      { label: ['TRIMMER-0',  120, 145], color:  'red', line: '', value:['comb_art_0_0', 'Random', 'NOUP', 100000000] },
      { label: ['TRIMMER-1',  120, 160], color:  'lime', line: '', value:['comb_art_1_1', 'Random', 'NOUP', 100000000] },
      { label: ['TRIMMER-10',  120, 175], color:  'blue', line: '', value:['comb_art_10_1', 'Random', 'NOUP', 100000000] },
      { label: ['TRIMMER-100',  120, 190], color:  'orange', line: '', value:['comb_art_100_1', 'Random', 'NOUP', 100000000] },
      { label: ['TRIMMER-1000',  120, 205], color:  'black', line: '', value:['comb_art_1000_1', 'Random', 'NOUP', 100000000] },
    ],
    group_by: 'algorithm',
  },
}
</script>


<br>
<br>

<table id="graph-data" style="font-size:11px" border="1"></table>

</body>
</html>
